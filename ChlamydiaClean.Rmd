Chlamydia data cleaning 
=======================

Richard T. Gray

This script is used to load and clean the raw chlamydia related data from 
various sources. These data are used for the chlamydia cascade 
calculations. 

## Data files and output

The raw data used for the chalmydia cascade is stored in three files in 
the ~/Evaluation\_Modelling/data/Chlamydia/raw folder:
- ChlamydiaNotifications-Year.csv
- CHLAMYDIA_MBS-Year.dta

and the file in ~/Evaluation\_Modelling/data/ACCESS/
- access\_cascade\_data-Year.xlsx (only available from 2015 onwards). 

The resulting cleaned data sets are saved as dataframes in three
csv files in the 
~/Evaluation\_Modelling/data/Chlamydia/ and
~/Evaluation\_Modelling/project\_care\_cascades/Chlamydia/data 
folder:
- clamnotificationsYear.csv
- chlamtestsYear.csv
- chlamtreatmentYear.csv

```{r Initialization}
# Restart R and set working directory to source file location

# Libraries for data manipulation
require(LeftysRpkg)
LoadLibrary(tidyverse)
LoadLibrary(readxl)

# Key folder paths
basePath <- file.path(path.expand("~"), "Research", "!Evaluation_Modelling")
dataPath <- file.path(basePath,"data","Chlamydia", "raw")
cleanDataFolder <- file.path(basePath,"data", "Chlamydia") # Cleaned data 

# Additional cleaned data folders for copies
cascadeDataFolder <- file.path(basePath,"project_care_cascades", 
  "Chlamydia", "data")

# Primary script parameters - data year 
dataYear <- 2014

```

## Chlamydia notifications

```{r notifications}
# Raw HIV notifications file
# Only works for 2014 at this stage
if (dataYear == 2014) {
  
  rawdata <- file.path(dataPath, paste0("ChlamydiaNotifications-",
    toString(dataYear), ".csv"))
  
  # Load the raw HIV notifications file and clean it up
  chlamdata <- read.csv(rawdata) 
  
  ### Clean up data
  
  # Fix up headings
  colnames(chlamdata) <- tolower(colnames(chlamdata))
  
  # Fix up sex labels
  chlamdata$sex <- tolower(chlamdata$sex)
  
  # Replace '-1's with NAs
  # chlamdata[chlamdata$sex == "missing",]$sex <- NA
  chlamdata[chlamdata$age == -1,]$age <- NA
  
  ### Group into the required age groups
  temp1 <- chlamdata %>% 
    filter(age < 15) %>%
    group_by(sex,year) %>% 
    summarise(n = sum(notification)) %>%
    spread(sex,n) %>%
    select(-year) %>%
    select(male,everything()) %>%
    rename("female < 15 yrs" = female, "male < 15 yrs" = male, 
      "missing < 15 yrs" = missing)
  
  temp15 <- chlamdata %>% 
    filter(age >= 15 & age <= 19) %>%
    group_by(sex,year) %>% 
    summarise(n = sum(notification)) %>%
    spread(sex,n) %>%
    select(-year) %>%
    select(male,everything()) %>%
    rename("female 15-19 yrs" = female, "male 15-19 yrs" = male, 
      "missing 15-19 yrs" = missing)
  
  temp20 <- chlamdata %>% 
    filter(age >= 20 & age <= 24) %>%
    group_by(sex,year) %>% 
    summarise(n = sum(notification)) %>%
    spread(sex,n) %>%
    select(-year) %>%
    select(male,everything()) %>%
    rename("female 20-24 yrs" = female, "male 20-24 yrs" = male, 
      "missing 20-24 yrs" = missing)
  
  temp25 <- chlamdata %>% 
    filter(age >= 25 & age <= 29) %>%
    group_by(sex,year) %>% 
    summarise(n = sum(notification)) %>%
    spread(sex,n) %>%
    select(-year) %>%
    select(male,everything()) %>%
    rename("female 25-29 yrs" = female, "male 25-29 yrs" = male, 
      "missing 25-29 yrs" = missing)
  
  temp30 <- chlamdata %>% 
    filter(age >= 30 & age <= 34) %>%
    group_by(sex,year) %>% 
    summarise(n = sum(notification)) %>%
    spread(sex,n) %>%
    select(-year) %>%
    select(male,everything()) %>%
    rename("female 30-34 yrs" = female, "male 30-34 yrs" = male, 
      "missing 30-34 yrs" = missing)
  
  temp35 <- chlamdata %>% 
    filter(age >= 35) %>%
    group_by(sex,year) %>% 
    summarise(n = sum(notification)) %>%
    spread(sex,n) %>%
    select(-year) %>%
    select(male,everything()) %>%
    rename("female > 34 yrs" = female, "male > 34 yrs" = male, 
      "missing >34 yrs" = missing)
  
  tempAll <- chlamdata %>% 
    group_by(sex,year) %>% 
    summarise(n = sum(notification)) %>%
    spread(sex,n) %>%
    select(-year) %>%
    select(male,everything()) %>%
    rename("female all" = female, "male all" = male, 
      "missing all" = missing)
  
  tempMiss <- chlamdata %>% 
    filter(is.na(age)) %>%
    group_by(sex,year) %>% 
    summarise(n = sum(notification)) %>%
    spread(sex,n) %>%
    select(-year) %>%
    select(male,everything()) %>%
    rename("female no age" = female, "male no age" = male, 
      "missing no age" = missing)
  
  #Bind into a wide data frame
  chlamNotifications <- cbind(temp1, temp15, temp20, temp25, temp30, temp35, 
    tempAll, tempMiss)
  
  # Rearrange to match model input
  chlamNotifications <- chlamNotifications %>% select(starts_with("male"), 
    starts_with("female"), 
    everything()) 
  
  ### Sort out missing data
  
  # Work out proportions in each age group each year 
  subNotifications <- chlamNotifications %>%
    select(ends_with("yrs"), -starts_with("missing")) 
  
  propNotifications <- subNotifications/apply(subNotifications, 1, sum, 
    na.rm = TRUE)
  
  allNotifications <- chlamNotifications %>%
    select(ends_with("all"), -starts_with("missing"))
  
  propNotificationsAll <- allNotifications/apply(allNotifications, 1, sum, 
    na.rm = TRUE)
  
  propNotifications <- cbind(propNotifications, propNotificationsAll)
  propNotifications <- select(propNotifications, 
    starts_with("male"), everything())
  
  # Distribute missing notifications across age groups
  missingNotifications <- chlamNotifications %>% 
    select(-ends_with("yrs"), -starts_with("female all"), 
      -starts_with("male all")) %>%
    apply(1, sum, na.rm = TRUE)
  
  extraNotifications <- round(propNotifications * missingNotifications)
  
  ### Estimate final number of notifications
  knownNotifications <- chlamNotifications %>%
    select(-starts_with("missing"), -ends_with("age"))
  
  finalNotifications <- knownNotifications + extraNotifications
  
  # A little test to see how important extra notifications are
  propKnown <- knownNotifications/finalNotifications
  
  # Final bind to year for reference
  year <- unique(chlamdata$year)
  finalNotifications <- cbind(year, finalNotifications)
  
  # Save cleaned chlamdata
  write.csv(finalNotifications, file = file.path(cleanDataFolder,           
    paste0("chlamnotifications_clean-", toString(dataYear), ".csv")), 
    row.names = FALSE)
  
  write.csv(finalNotifications, file = file.path(cascadeDataFolder,           
    paste0("chlamnotifications_clean-", toString(dataYear), ".csv")), 
    row.names = FALSE)
  
}
```


## Chlamydia tests

```{r tests}

LoadLibrary(haven)
LoadLibrary(readstata13)

# Raw testing file
rawdata <- file.path(dataPath, paste0("CHLAMYDIA_MBS-", 
  toString(dataYear), ".dta"))

# Load raw testing data
if (dataYear < 2015) {
  chlamtests <- read_dta(rawdata)
} else {
  chlamtests <- read.dta13(rawdata)
}

# Clean up data ----------------------------------------------------------

# Fix up headings
colnames(chlamtests) <- tolower(colnames(chlamtests))

# Fix up sex & state labels
chlamtests$sex <- tolower(chlamtests$sex)
chlamtests$state <- tolower(chlamtests$state)

# Convert tests to numeric
chlamtests$tests <- as.numeric(chlamtests$tests)

# Select national data
chlamtests <- filter(chlamtests, state == "aus")

# Create a year variable
chlamtests$year <- NA

for (ii in 1:nrow(chlamtests)) {
  tempstr <- chlamtests$date[ii]
  #   tempSplit <- strsplit(tempstr, "-")
  #   year <- tempSplit[[1]][2]
  year <- format(tempstr, "%Y")
  #   year <- paste("20", year, sep = "")
  chlamtests$year[ii] <- year
}

# Arrange by year
chlamtests <- arrange(chlamtests,year)

# Calculate total for each year, age group and sex
chlamtests <- chlamtests %>%
  group_by(age, year, sex) %>%
  summarise(total = sum(tests)) %>% 
  spread(age, total) %>%
  ungroup()

# Sum age categories - do this manually
youngtests <- chlamtests %>% 
  select(one_of(c("0-4", "5-14"))) %>% 
  apply(1,sum)

oldtests <- chlamtests %>% 
  select(one_of(c(">=85", "35-44", "45-54", "55-64", "65-74", 
    "75-84"))) %>% 
  apply(1,sum)

chlamtests$young <- youngtests
chlamtests$old <- oldtests

# Finally pull out the columns we need
chlamtests <- chlamtests %>% 
  select(-one_of(c(">=85", "35-44", "45-54", "55-64", "65-74", "75-84",
    "0-4", "5-14"))) %>%
  rename("<15" = young, ">34" = old)

# Reorgonize into the format we need --------------------------------------

# Male tests
maletests <- chlamtests %>%
  filter(sex == "male") %>%
  select(-year, -sex) %>%
  select(one_of("<15"), everything())

colnames(maletests) <- c("males < 15 yrs", "males 15-24 yrs", 
  "males 25-34 yrs", "males > 34 yrs")
maletests$all <- apply(maletests, 1, sum)

# Female tests
femaletests <- chlamtests %>%
  filter(sex == "female") %>%
  select(-year, -sex) %>%
  select(one_of("<15"), everything())

colnames(femaletests) <- c("females < 15 yrs", "females 15-24 yrs", 
  "females 25-34 yrs", "females > 34 yrs")
femaletests$all <- apply(femaletests, 1, sum)

# Bind the male and female tests
year <- unique(as.numeric(chlamtests$year))
finalTests <- cbind(year, maletests, femaletests)

# Save cleaned chlamdata
write.csv(finalTests, file = file.path(cleanDataFolder, 
  paste0("chlamtests_clean-", toString(dataYear), ".csv")), 
  row.names = FALSE)

```


## Chlamydia re-testing data (ACCESS data)

The following chunk cleans up data on the numbers of people re-tested for 
chlamydia in urban, regional, and remote areas in sexual health clinics 
and in general practise. This data is saved in long format. From this data
proportions and the lower and upper bounds based on 95% confidence
intervals are calculated.  

```{r re-testing ACCESS}
# ACCESS re-testing data
dataStartYear <- 2007
mergeRemote <-TRUE # add remote and regional data

# For ACCESS re-testing data do we want a split in male re-tests into MSM
# and non-MSM
msmSplit <- ifelse(dataYear >= 2016, TRUE, FALSE)
# msmSplit <- FALSE # to overwrite

# Raw testing file
if (msmSplit) {
  rawDataTreatment <- file.path(dataPath, paste0("access_cascade_data-", 
    toString(dataYear), "_MSM.xlsx"))
} else {
  rawDataTreatment <- file.path(dataPath, paste0("access_cascade_data-", 
    toString(dataYear), ".xlsx"))
}

# Load raw re-testing data
chlamRetest <- read_excel(rawDataTreatment, sheet = 1, skip = 3,
  col_names = FALSE)

# For some reason 7th column is read as char
chlamRetest$X__7 <- as.numeric(chlamRetest$X__7)

# Clean up data ----------------------------------------------------------

colnames(chlamRetest)[1] <- "setting"
colnames(chlamRetest)[2] <- "variable"

# Manually relable columns by all, male and female data
dataYears <- dataStartYear:(dataStartYear + 
    (dataYear - dataStartYear))
numDataYears <- length(dataYears)

colnames(chlamRetest)[3:(3 + numDataYears - 1)] <- 
  paste0(dataYears, "all")
if (msmSplit) {
  colnames(chlamRetest)[(3 + numDataYears + 1):(3 + 2 * numDataYears)] <- 
    paste0(dataYears, "non_msm")
  colnames(chlamRetest)[(3 + 2 * numDataYears + 2):
      (3 + 3 * numDataYears + 1)] <- paste0(dataYears,
        "msm")
  colnames(chlamRetest)[(3 + 3 * numDataYears + 3):
      (3 + 4 * numDataYears + 2)] <- paste0(dataYears,
        "female")
} else {
  colnames(chlamRetest)[(3 + numDataYears + 1):(3 + 2 * numDataYears)] <- 
    paste0(dataYears, "male")
  colnames(chlamRetest)[(3 + 2 * numDataYears + 2):
      (3 + 3 * numDataYears + 1)] <- paste0(dataYears,
        "female")
}

# Get rid of excess rows and columns
chlamRetest <- chlamRetest %>% 
  select(-contains("X_")) %>%
  filter(!is.na(variable))

# Just keep the data and calculate proportions separately
chlamRetest <- chlamRetest %>%
  filter(variable %in% c("# of diagnoses", "# re-tested in 42-180 days"))

# clean variable names
chlamRetest[chlamRetest$variable == "# of diagnoses", ]$variable <-
  "diagnoses"
chlamRetest[chlamRetest$variable == "# re-tested in 42-180 days",
  ]$variable <- "retested"

# Pull out setting and copy
settingNames <- filter(chlamRetest, !is.na(setting))$setting
chlamRetest[is.na(chlamRetest$setting), ]$setting <- settingNames

# Split setting names into two variables
settingList <- strsplit(chlamRetest$setting, " - ")
chlamRetest$context <- sapply(settingList, function(x) x[1])
chlamRetest$region <- sapply(settingList, function(x) x[2])

chlamRetest <- chlamRetest %>%
  select(-setting) %>%
  select(region, context, everything())

# Rename context variable
chlamRetest[chlamRetest$context == "Sexual health network", ]$context <-
  "shc"
chlamRetest[chlamRetest$context == "GP network", ]$context <-
  "gp"

# Convert to long format -------------------------------------------------
chlamRetest <- chlamRetest %>%
  gather("yearsex", "number", 4:ncol(chlamRetest))

# Split year and sex
yearsexYear <- as.character(sapply(chlamRetest$yearsex, 
  function(s) substr(s, 1, 4)))
yearsexSex <- as.character(sapply(chlamRetest$yearsex, 
  function(s) substr(s, 5, nchar(s))))

chlamRetest$sex <- yearsexSex
chlamRetest$year <- yearsexYear

# Final reformat in preparation for calculations -------------------------

chlamRetest <- chlamRetest %>%
  select(-yearsex) %>%
  spread(variable, number)

if (mergeRemote) {
  # Add another set of rows for regional+remote data
  mergedData <-  filter(chlamRetest, region == "regional") # initialize
  mergedData$region <- "regional+remote" # change region name
  
  # Add regional and remote data
  mergedData$diagnoses <- filter(chlamRetest, 
    region == "regional")$diagnoses +
    filter(chlamRetest, region == "remote")$diagnoses
  mergedData$retested <- filter(chlamRetest, 
    region == "regional")$retested +
    filter(chlamRetest, region == "remote")$retested
  
  # Add to chlamRetest
  chlamRetest <- bind_rows(chlamRetest, mergedData)
  
}

# Replace NAs with zeros
chlamRetest[is.na(chlamRetest)] <- 0

# Calculate overall male if we have split by MSM
if (msmSplit) {
  maleData <- chlamRetest %>%
    filter(sex %in% c("msm", "non_msm")) %>%
    group_by(region, context, year) %>%
    summarise(sex = "male",
      diagnoses = sum(diagnoses),
      retested = sum(retested)) %>%
    ungroup()
  
  # Add to all data
  chlamRetest <- chlamRetest %>%
    bind_rows(maleData) %>%
    arrange(region, context, year)
  
}

# Now calculate proportion retest and lower and upper bound --------------
chlamRetest <- chlamRetest %>%
  mutate(prop_retested = retested / diagnoses)

# Need to remove NAs to calculate upper and lower 95% confidence intervals
# using prop.test

LowerProp <- function(x, y) prop.test(x, y)[[6]][1]
UpperProp <- function(x, y) prop.test(x, y)[[6]][2]

indices <- (!is.na(chlamRetest$retested) &
  (chlamRetest$diagnoses != 0))

propLower <- mapply(LowerProp, chlamRetest$retested[indices],
  chlamRetest$diagnoses[indices])
propUpper <- mapply(UpperProp, chlamRetest$retested[indices],
  chlamRetest$diagnoses[indices])

chlamRetest$prop_lower <- NA
chlamRetest$prop_upper <- NA

chlamRetest[indices, ]$prop_lower <- propLower
chlamRetest[indices, ]$prop_upper <- propUpper

# Extract data year and write to file ------------------------------------

chlamRetest <- chlamRetest %>%
  filter(year == dataYear)

# Write to file 
if (msmSplit) {
  write.csv(chlamRetest, file = file.path(cleanDataFolder,
    paste0("retestsAccess_clean-", toString(dataYear), "_MSM.csv")),
    row.names = FALSE)
  
  write.csv(chlamRetest, file = file.path(cascadeDataFolder,
    paste0("retestsAccess_clean-", toString(dataYear), "_MSM.csv")),
    row.names = FALSE)
} else {
  write.csv(chlamRetest, file = file.path(cleanDataFolder,
    paste0("retestsAccess_clean-", toString(dataYear), ".csv")),
    row.names = FALSE)
  
  write.csv(chlamRetest, file = file.path(cascadeDataFolder,
    paste0("retestsAccess_clean-", toString(dataYear), ".csv")),
    row.names = FALSE)
}
```

```{r retesting ACCEPt}
# Read in available ACCEPt data. We use the control group data on the 
# second sheet. Only available up to 2014
dataStartYear <- 2010

# Raw testing file
rawDataTreatment <- file.path(dataPath, paste0("accept_cascade_data-2015.xlsx"))

# Load raw re-testing data for control group
retestAccept <- read_excel(rawDataTreatment, sheet = 2, skip = 3,
  col_names = FALSE)

# Clean up data ----------------------------------------------------------

colnames(retestAccept)[1] <- "setting"
colnames(retestAccept)[2] <- "variable"

# Manually relable columns by all, male and female data
# Available data only goes up to 2014
dataYears <- dataStartYear:(dataStartYear + 
    (min(dataYear, 2014) - dataStartYear))
numDataYears <- length(dataYears)

colnames(retestAccept)[3:(3 + numDataYears - 1)] <- 
  dataYears

# Get rid of excess rows and columns
retestAccept <- retestAccept[1:27, 1:7]
retestAccept <- retestAccept[c(1:12, 14:27), ]

# Just keep the data and calculate proportions separately
retestAccept <- retestAccept %>%
  filter(variable %in% c("# of diagnoses", "# re-tested in 42-180 days"))

# clean variable names
retestAccept[retestAccept$variable == "# of diagnoses", ]$variable <-
  "diagnoses"
retestAccept[retestAccept$variable == "# re-tested in 42-180 days",
  ]$variable <- "retested"

# Pull out setting, copy and fix up names
settingNames <- filter(retestAccept, !is.na(setting))$setting
retestAccept[is.na(retestAccept$setting), ]$setting <- settingNames

retestAccept[retestAccept$setting == "Regional - inner/outer",
  ]$setting <- "Regional"
retestAccept[retestAccept$setting == "Remote/very remote",
  ]$setting <- "Remote"

# Split setting names into two variables
# settingList <- strsplit(retestAccept$setting, " - ")
# retestAccept$context <- sapply(settingList, function(x) x[1])
# retestAccept$region <- sapply(settingList, function(x) x[2])

# Add region and context
retestAccept$region <- tolower(retestAccept$setting)
retestAccept$context <- "gp"

retestAccept <- retestAccept %>%
  select(-setting) %>%
  select(region, context, everything())

# Add colume for sex 
retestAccept <- retestAccept %>%
  mutate(sex = rep(c("male", "female"), each = 6)) %>%
  select(region, context, sex, variable, everything()) %>%
  gather("year", "number", 5:(ncol(retestAccept)+1)) %>%
  spread(variable, number)

# Add estimates for "all" by adding the numbers for males and females
retestAll <- retestAccept %>%
  filter(sex == "male")
retestAll$sex <- "all"

retestAll$diagnoses <-
  retestAccept$diagnoses[retestAccept$sex == "female"] +
  retestAccept$diagnoses[retestAccept$sex == "male"]

retestAll$retested <-
  retestAccept$retested[retestAccept$sex == "female"] +
  retestAccept$retested[retestAccept$sex == "male"]

retestAccept <- bind_rows(retestAccept, retestAll)

# Now calculate proportion retest and lower and upper bound --------------
retestAccept <- retestAccept %>%
  mutate(prop_retested = retested / diagnoses)

# Need to remove NAs to calculate upper and lower 95% confidence intervals
# using prop.test

LowerProp <- function(x, y) prop.test(x, y)[[6]][1]
UpperProp <- function(x, y) prop.test(x, y)[[6]][2]

indices <- !is.na(retestAccept$retested)

propLower <- mapply(LowerProp, retestAccept$retested[indices],
  retestAccept$diagnoses[indices])
propUpper <- mapply(UpperProp, retestAccept$retested[indices],
  retestAccept$diagnoses[indices])

retestAccept$prop_lower <- NA
retestAccept$prop_upper <- NA

retestAccept[indices, ]$prop_lower <- propLower
retestAccept[indices, ]$prop_upper <- propUpper

# Extract data year and write to file ------------------------------------

retestAccept <- retestAccept %>%
  filter(year == min(dataYear, 2014)) # data only available up to 2014

# Write to file
write.csv(retestAccept, file = file.path(cleanDataFolder,
  paste0("retestsAccept_clean-", toString(min(dataYear, 2014)), ".csv")),
  row.names = FALSE)

write.csv(retestAccept, file = file.path(cascadeDataFolder,
  paste0("retestsAccept_clean-", toString(min(dataYear, 2014)), ".csv")),
  row.names = FALSE)

```

```{r restesting NSW GP}
# Read in NSW GP data from ACCESS in 2015 and clean it up. This data was 
# used for the 2015 CT cascade in the 2016 ASR.
dataStartYear <- 2007
dataEndYear <- 2015

# Raw testing file
rawDataTreatment <- file.path(dataPath,
  paste0("access_nsw_gp_data-2015.xlsx"))

# Load raw re-testing data for 15-29 year olds in NSW GPs
retestNSWgp <- read_excel(rawDataTreatment, sheet = 2, skip = 3,
  col_names = FALSE)

# Clean up data ----------------------------------------------------------

colnames(retestNSWgp)[1] <- "setting"
colnames(retestNSWgp)[2] <- "variable"

# Manually relable columns by all, male and female data
dataYears <- dataStartYear:(dataStartYear + 
    (dataEndYear - dataStartYear))
numDataYears <- length(dataYears)

colnames(retestNSWgp)[3:(3 + numDataYears - 1)] <- 
  dataYears

# Get rid of excess rows and columns
retestNSWgp <- retestNSWgp[1:27, 1:11]
retestNSWgp <- retestNSWgp[c(1:12, 14:27), ]

# Just keep the data and calculate proportions separately
retestNSWgp <- retestNSWgp %>%
  filter(variable %in% c("# of diagnoses", "# re-tested in 42-180 days"))

# clean variable names
retestNSWgp[retestNSWgp$variable == "# of diagnoses", ]$variable <-
  "diagnoses"
retestNSWgp[retestNSWgp$variable == "# re-tested in 42-180 days",
  ]$variable <- "retested"

# Pull out setting and copy
settingNames <- filter(retestNSWgp, !is.na(setting))$setting
retestNSWgp[is.na(retestNSWgp$setting), ]$setting <- settingNames

# Split setting names into two variables
settingList <- strsplit(retestNSWgp$setting, " - ")
retestNSWgp$context <- sapply(settingList, function(x) x[1])
retestNSWgp$region <- sapply(settingList, function(x) x[2])

retestNSWgp <- retestNSWgp %>%
  select(-setting) %>%
  select(region, context, everything())

# Rename context variable
retestNSWgp[retestNSWgp$context == "GP network", ]$context <-
  "gp"

# Add colume for sex 
retestNSWgp <- retestNSWgp %>%
  mutate(sex = rep(c("male", "female"), each = 6)) %>%
  select(region, context, sex, variable, everything()) %>%
  gather("year", "number", 5:(ncol(retestNSWgp)+1)) %>%
  spread(variable, number)

# Add estimates for "all" by adding the numbers for males and females
retestAll <- retestNSWgp %>%
  filter(sex == "male")
retestAll$sex <- "all"

retestAll$diagnoses <- 
  retestNSWgp$diagnoses[retestNSWgp$sex == "female"] +
  retestNSWgp$diagnoses[retestNSWgp$sex == "male"]

retestAll$retested <-
  retestNSWgp$retested[retestNSWgp$sex == "female"] +
  retestNSWgp$retested[retestNSWgp$sex == "male"]

retestNSWgp <- bind_rows(retestNSWgp, retestAll)

# Now calculate proportion retest and lower and upper bound --------------
retestNSWgp <- retestNSWgp %>%
  mutate(prop_retested = retested / diagnoses)

# Need to remove NAs to calculate upper and lower 95% confidence intervals
# using prop.test

LowerProp <- function(x, y) prop.test(x, y)[[6]][1]
UpperProp <- function(x, y) prop.test(x, y)[[6]][2]

indices <- !is.na(retestNSWgp$retested)

propLower <- mapply(LowerProp, retestNSWgp$retested[indices],
  retestNSWgp$diagnoses[indices])
propUpper <- mapply(UpperProp, retestNSWgp$retested[indices],
  retestNSWgp$diagnoses[indices])

retestNSWgp$prop_lower <- NA
retestNSWgp$prop_upper <- NA

retestNSWgp[indices, ]$prop_lower <- propLower
retestNSWgp[indices, ]$prop_upper <- propUpper

# Extract data year and write to file ------------------------------------

retestNSWgp <- retestNSWgp %>%
  filter(year == dataEndYear)

# Write to file
write.csv(retestNSWgp, file = file.path(cleanDataFolder,
  paste0("retestsNSWgp_clean-2015.csv")),
  row.names = FALSE)

write.csv(retestNSWgp, file = file.path(cascadeDataFolder,
  paste0("retestsNSWgp_clean-2015.csv")),
  row.names = FALSE)

```

```{r retesting range}
# This chunk cleans the data for different periods for re-testing from the
# ACCESS sexual health clinic data. 

dataStartYear <- 2007

# Raw testing file
if (msmSplit) {
  rawDataTreatment <- file.path(dataPath, 
    paste0("access_chlamydia_shc_data-", toString(dataYear), "_MSM.xlsx"))
} else {
  rawDataTreatment <- file.path(dataPath, 
    paste0("access_chlamydia_shc_data-", toString(dataYear), ".xlsx"))
}

# Load raw re-testing data for 15-29 year olds in NSW GPs
retestVariation <- read_excel(rawDataTreatment, sheet = 1, skip = 3,
  col_names = FALSE)

# Clean up data ----------------------------------------------------------

colnames(retestVariation)[1] <- "setting"
colnames(retestVariation)[2] <- "variable"

# Manually relable columns by all, male and female data
dataYears <- dataStartYear:(dataStartYear + (dataYear - dataStartYear))
numDataYears <- length(dataYears)

colnames(retestVariation)[3:(3 + numDataYears - 1)] <- 
  paste0(dataYears, "all")
if (msmSplit) {
  colnames(retestVariation)[(3 + numDataYears + 1):
      (3 + 2 * numDataYears)] <- paste0(dataYears, "non_msm")
  colnames(retestVariation)[(3 + 2 * numDataYears + 2):
      (3 + 3 * numDataYears + 1)] <- paste0(dataYears, "msm")
  colnames(retestVariation)[(3 + 3 * numDataYears + 3):
      (3 + 4 * numDataYears + 2)] <- paste0(dataYears, "females")
} else {
  colnames(retestVariation)[(3 + numDataYears + 1):
      (3 + 2 * numDataYears)] <- paste0(dataYears, "males")
  colnames(retestVariation)[(3 + 2 * numDataYears + 2):
      (3 + 3 * numDataYears + 1)] <- paste0(dataYears, "females")
}

# Get rid of excess rows and columns
retestVariation <- retestVariation %>% 
  select(-contains("X_")) %>%
  filter(!is.na(variable))

# Just keep the data and calculate proportions separately
retestVariation <- retestVariation %>%
  filter(variable %in% c("# of diagnoses", "# re-tested in 42-180 days",
    "# re-tested in 42-120 days",
    "# re-tested in 7-180 days"))

# clean variable names
retestVariation[retestVariation$variable == "# of diagnoses", 
  ]$variable <- "diagnoses"
retestVariation[retestVariation$variable == "# re-tested in 42-180 days",
  ]$variable <- "retested42-180"
retestVariation[retestVariation$variable == "# re-tested in 42-120 days",
  ]$variable <- "retested42-120"
retestVariation[retestVariation$variable == "# re-tested in 7-180 days",
  ]$variable <- "retested7-180"

# Pull out setting and copy
settingNames <- filter(retestVariation, !is.na(setting))$setting
retestVariation[is.na(retestVariation$setting), ]$setting <- settingNames

# Split setting names into two variables
settingList <- strsplit(retestVariation$setting, " - ")
retestVariation$context <- sapply(settingList, function(x) x[1])
retestVariation$region <- sapply(settingList, function(x) x[2])

retestVariation <- retestVariation %>%
  select(-setting) %>%
  select(region, context, everything())

# Rename context variable
retestVariation[retestVariation$context == "Sexual health network", 
  ]$context <- "shc"

# Convert to long format -------------------------------------------------
retestVariation <- retestVariation %>%
  gather("yearsex", "number", 4:ncol(retestVariation))

# Split year and sex
yearsexYear <- as.character(sapply(retestVariation$yearsex, 
  function(s) substr(s, 1, 4)))
yearsexSex <- as.character(sapply(retestVariation$yearsex, 
  function(s) substr(s, 5, nchar(s))))

retestVariation$sex <- yearsexSex
retestVariation$year <- yearsexYear

# Final reformat in preparation for calculations -------------------------

retestVariation <- retestVariation %>%
  select(-yearsex) %>%
  distinct() %>%
  spread(variable, number)

# Reformat retesting period
retestVariation <- retestVariation %>%
  rename(`42-120` = `retested42-120`, `42-180` = `retested42-180`,
    `7-180` = `retested7-180`) %>%
  gather("period", "retested", 6:8) %>%
  mutate(retested = as.numeric(retested),
    diagnoses = as.numeric(diagnoses))

# Replace NAs with zeros
retestVariation[is.na(retestVariation)] <- 0

# Calculate overall male if we have split by MSM
if (msmSplit) {
  maleData <- retestVariation %>%
    filter(sex %in% c("msm", "non_msm")) %>%
    group_by(region, context, year, period) %>%
    summarise(sex = "male",
      diagnoses = sum(diagnoses),
      retested = sum(retested)) %>%
    ungroup()
  
  # Add to all data
  retestVariation <- retestVariation %>%
    bind_rows(maleData) %>%
    arrange(region, context, year, period)
  
}

# Now calculate proportion retest and lower and upper bound --------------
retestVariation <- retestVariation %>%
  mutate(prop_retested = retested / diagnoses)

# Need to remove NAs to calculate upper and lower 95% confidence intervals
# using prop.test

LowerProp <- function(x, y) prop.test(x, y)[[6]][1]
UpperProp <- function(x, y) prop.test(x, y)[[6]][2]

qcal <- function(x, y) round(100*c(x/y, LowerProp(x, y), UpperProp(x, y)),
  digits = 1)

indices <- (!is.na(retestVariation$retested) &
  (retestVariation$diagnoses != 0))

propLower <- mapply(LowerProp, retestVariation$retested[indices],
  retestVariation$diagnoses[indices])
propUpper <- mapply(UpperProp, retestVariation$retested[indices],
  retestVariation$diagnoses[indices])

retestVariation$prop_lower <- NA
retestVariation$prop_upper <- NA

retestVariation[indices, ]$prop_lower <- propLower
retestVariation[indices, ]$prop_upper <- propUpper

retestVariation[is.na(retestVariation)] <- 0

# Extract data year and write to file ------------------------------------

retestVariation <- retestVariation %>%
  filter(year == dataYear)

# Write to file
if (msmSplit) {
  write.csv(retestVariation, file = file.path(cleanDataFolder,
    paste0("chlamRetestVariation_clean-", toString(dataYear), "_MSM.csv")),
    row.names = FALSE)
  
  write.csv(retestVariation, file = file.path(cascadeDataFolder,
    paste0("chlamRetestVariation_clean-", toString(dataYear), "_MSM.csv")),
    row.names = FALSE)
  
} else {
  write.csv(retestVariation, file = file.path(cleanDataFolder,
    paste0("chlamRetestVariation_clean-", toString(dataYear), ".csv")),
    row.names = FALSE)
  
  write.csv(retestVariation, file = file.path(cascadeDataFolder,
    paste0("chlamRetestVariation_clean-", toString(dataYear), ".csv")),
    row.names = FALSE)
}

```

